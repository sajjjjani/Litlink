<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Litlink</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <a href="index.html" class="close-btn">&times;</a>
            </div>
            
            <div class="verification-content" id="verificationContent">
                <div class="verification-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                
                <h3>Reset Your Password</h3>
                <p>Enter the 6-digit OTP sent to your email and set a new password.</p>
                
                <div class="verification-email" id="otpEmail">
                    Loading email...
                </div>
                
                <div id="step1">
                    <form id="verifyOTPForm">
                        <div class="form-group">
                            <label for="otpCode">Enter OTP</label>
                            <div class="input-with-icon">
                                <i class="fas fa-mobile-alt"></i>
                                <input type="text" id="otpCode" placeholder="6-digit OTP" maxlength="6" required>
                            </div>
                            <div class="error-message" id="otpCodeError"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-modal-submit" id="verifyOTPSubmit">Verify OTP</button>
                    </form>
                </div>
                
                <div id="step2" style="display: none;">
                    <form id="resetPasswordForm">
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="newPassword" placeholder="Enter new password" required>
                            </div>
                            <div class="password-requirements">
                                <p>Password must contain:</p>
                                <ul>
                                    <li id="req-length-2" class="req-unmet"><i class="fas fa-times"></i> At least 8 characters</li>
                                    <li id="req-uppercase-2" class="req-unmet"><i class="fas fa-times"></i> One uppercase letter</li>
                                    <li id="req-number-2" class="req-unmet"><i class="fas fa-times"></i> One number</li>
                                    <li id="req-special-2" class="req-unmet"><i class="fas fa-times"></i> One special character</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
                            </div>
                            <div class="error-message" id="confirmPasswordError"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-modal-submit" id="resetPasswordBtn">Reset Password</button>
                    </form>
                </div>
                
                <div class="verification-footer">
                    <p><a href="#" id="resendOTPLink">Resend OTP</a></p>
                    <p><a href="index.html">← Back to Home</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email') || sessionStorage.getItem('resetEmail');
            const otpFromURL = urlParams.get('otp');
            const otpEmailElement = document.getElementById('otpEmail');
            const otpForm = document.getElementById('verifyOTPForm');
            const otpCodeInput = document.getElementById('otpCode');
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const resendOTPLink = document.getElementById('resendOTPLink');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
            const verificationContent = document.getElementById('verificationContent');
            
            if (email) {
                otpEmailElement.textContent = email;
                sessionStorage.setItem('resetEmail', email);
            } else {
                otpEmailElement.textContent = 'No email found';
                otpEmailElement.style.color = '#ef4444';
            }
            
            if (otpFromURL) {
                otpCodeInput.value = otpFromURL;
            }
            
            // Password validation
            function validatePassword(password) {
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
                };
                
                Object.keys(requirements).forEach(key => {
                    const element = document.getElementById(`req-${key}-2`);
                    if (element) {
                        if (requirements[key]) {
                            element.classList.remove('req-unmet');
                            element.classList.add('req-met');
                            const icon = element.querySelector('i');
                            if (icon) icon.className = 'fas fa-check';
                        } else {
                            element.classList.remove('req-met');
                            element.classList.add('req-unmet');
                            const icon = element.querySelector('i');
                            if (icon) icon.className = 'fas fa-times';
                        }
                    }
                });
                
                return Object.values(requirements).every(Boolean);
            }
            
            newPasswordInput.addEventListener('input', function() {
                validatePassword(this.value);
            });
            
            confirmNewPasswordInput.addEventListener('input', function() {
                const newPassword = newPasswordInput.value;
                const confirm = this.value;
                
                if (confirm && newPassword !== confirm) {
                    document.getElementById('confirmPasswordError').textContent = 'Passwords do not match';
                } else {
                    document.getElementById('confirmPasswordError').textContent = '';
                }
            });
            
            // OTP verification
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const otpCode = otpCodeInput.value.trim();
                
                if (!otpCode || otpCode.length !== 6) {
                    alert('Please enter a valid 6-digit OTP');
                    otpCodeInput.focus();
                    return;
                }
                
                try {
                    const response = await fetch('http://localhost:5002/api/auth/verify-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, otp: otpCode })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('OTP verified! Now set your new password.');
                        step1.style.display = 'none';
                        step2.style.display = 'block';
                    } else {
                        alert('OTP verification failed: ' + data.message);
                        otpCodeInput.focus();
                    }
                } catch (error) {
                    console.error('OTP verification error:', error);
                    alert('Unable to connect to the server. Please check your internet connection and try again.');
                }
            });
            
            // Reset password
            resetPasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmNewPasswordInput.value;
                
                if (!newPassword || !confirmPassword) {
                    alert('Please fill in all fields');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                if (!validatePassword(newPassword)) {
                    alert('Password must be at least 8 characters with uppercase, number, and special character');
                    return;
                }
                
                try {
                    const response = await fetch('http://localhost:5002/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, newPassword })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Show success message
                        verificationContent.innerHTML = `
                            <div class="verification-icon" style="color: #10b981;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Password Reset Successful!</h3>
                            <p>Your password has been reset successfully. You can now login with your new password.</p>
                            <div style="margin: 30px 0;">
                                <button onclick="window.location.href='index.html'" class="btn btn-modal-submit">
                                    Go to Login
                                </button>
                            </div>
                            <div class="verification-footer">
                                <p><a href="index.html">← Back to Home</a></p>
                            </div>
                        `;
                        
                        // Clear storage
                        sessionStorage.removeItem('resetEmail');
                    } else {
                        alert('Password reset failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    alert('Unable to connect to the server. Please check your internet connection and try again.');
                }
            });
            
            // Resend OTP
            resendOTPLink.addEventListener('click', async function(e) {
                e.preventDefault();
                
                try {
                    const response = await fetch('http://localhost:5002/api/auth/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('New OTP sent! Please check your email.');
                        otpCodeInput.value = data.otp;
                    } else {
                        alert('Failed to resend OTP: ' + data.message);
                    }
                } catch (error) {
                    console.error('Resend OTP error:', error);
                    alert('Unable to connect to the server. Please check your internet connection and try again.');
                }
            });
        });
    </script>
    <script src="../utils/modal.js"></script>
</body>
</html>